{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symmetric Cipher Tool</title>
    <link rel="icon" type="image/png" href="{% static 'img/icon.png' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}"/>
</head>
<body>
    <!-- Modal for displaying the step-by-step encryption/decryption process -->
    <div id="solution-modal" class="solution-modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Encryption/Decryption Process</h3>
            <div id="modal-steps-container">{{ steps }}</div>
            <button class="modal-close-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <button id="mode-toggle" class="mode-toggle" aria-label="Toggle Dark/Light Mode">
        ðŸŒ“
    </button>

    <button onclick="resetFields()" class="reset-button">Reset</button>

    <div class="cipher-container">
        <div class="cipher-header">
            <h1>Symmetric Cipher Tool</h1>
        </div>
        
        <div class="cipher-selector">
            <button onclick="selectCipher('caesar')">Caesar</button>
            <button onclick="selectCipher('vigenere')">VigenÃ¨re</button>
            <button onclick="selectCipher('playfair')">Playfair</button>
            <button onclick="selectCipher('single-columnar')">Single Columnar</button>
            <button onclick="selectCipher('double-columnar')">Double Columnar</button>
            <button onclick="selectCipher('aes')">AES</button>
        </div>

        <div id="cipher-inputs" class="cipher-input">
            <div id="keys-container" class="keys-container">
                <input type="text" id="key-input" placeholder="Enter shift value (1-25)" {% if key %}value="{{ key }}"{% endif %}>
                <input type="text" id="key-input-2" placeholder="Enter second key for Double Columnar Cipher" style="display: none;" {% if key %}value="{{ key2 }}"{% endif %}>
            </div>
            <textarea id="text-input" placeholder="Enter text to encrypt/decrypt">{% if key %}{{ text }}{% endif %}</textarea>
        </div>

        <div class="cipher-actions">
            <button onclick="encrypt()">Encrypt</button>
            <button onclick="decrypt()">Decrypt</button>
        </div>

        <div class="cipher-output">
            <button class="show-solution-btn" onclick="triggerModal()">View Solution</button>
            <h3>Result:</h3>
            <p id="result-output">{%if data %}
                {{ data }}
                {% endif %}
            </p>
            
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cipherContainer = document.querySelector('.cipher-container');
            if (cipherContainer) {
                cipherContainer.style.opacity = '1'; // Ensure visibility after animation
            }
        });

        const encryptionSteps = `{{ steps|safe }}`;
        const mode = `{{ mode|safe }}`;
        function triggerModal() {
            showModal(encryptionSteps);
        }

        // Dark/Light Mode Toggle
        const modeToggle = document.getElementById('mode-toggle');
        const htmlElement = document.documentElement;

        // Check for saved theme preference or system preference
        const savedTheme = localStorage.getItem('cipher-theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');

        // Set initial theme
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark.matches)) {
            htmlElement.classList.add('dark-mode');
            modeToggle.classList.remove('rotated');
        } else {
            modeToggle.classList.add('rotated');
        }

        modeToggle.addEventListener('click', () => {
            // Toggle dark mode
            htmlElement.classList.toggle('dark-mode');
            
            // Toggle rotation state
            if (modeToggle.classList.contains('rotated')) {
                modeToggle.classList.remove('rotated');
            } else {
                modeToggle.classList.add('rotated');
            }

            // Save preference
            const currentTheme = htmlElement.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('cipher-theme', currentTheme);
        });

        let currentCipher;

        {% if cipher %}
            currentCipher = "{{ cipher|safe }}"; 
            {% if cipher == 'double-columnar' %}
                const keyInput2 = document.getElementById('key-input-2');
                keyInput2.style.display = 'block';
            {% endif %}
        {% else %}
            currentCipher = 'caesar'; 
        {% endif %}

        function selectCipher(cipher) {
            document.querySelectorAll('.cipher-selector button').forEach(btn => {
                btn.classList.remove('active');
            });

            event.target.classList.add('active');
            currentCipher = cipher;

            const keyInput = document.getElementById('key-input');
            const keyInput2 = document.getElementById('key-input-2');

            // Reset both inputs
            keyInput.style.display = 'block';
            keyInput2.style.display = 'none';

            document.getElementById('key-input').value = '';
            document.getElementById('key-input-2').value = '';
            document.getElementById('text-input').value = '';
            document.getElementById('result-output').textContent = '';

            switch(cipher) {
                case 'caesar':
                    keyInput.placeholder = 'Enter shift value (1-25)';
                    keyInput.type = 'number';
                    break;
                case 'vigenere':
                    keyInput.placeholder = 'Enter alphabetic key';
                    keyInput.type = 'text';
                    break;
                case 'playfair':
                    keyInput.placeholder = 'Enter keyword for matrix';
                    keyInput.type = 'text';
                    break;
                case 'single-columnar':
                    keyInput.placeholder = 'Enter column order (e.g., 4231)';
                    keyInput.type = 'text';
                    break;
                case 'double-columnar':
                    keyInput.placeholder = 'Enter first key for Double Columnar Cipher';
                    keyInput2.style.display = 'block'; // Show second key input
                    keyInput2.placeholder = 'Enter second key for Double Columnar Cipher';
                    break;
                case 'aes':
                    keyInput.placeholder = 'Enter AES key (128/192/256 bits)';
                    keyInput.type = 'text';
                    break;
            }
        }

        function encrypt() {
            const resultOutput = document.getElementById('result-output');
            let key, key2, text;

            // Get inputs based on current cipher
            if (currentCipher === 'double-columnar') {
                key = document.getElementById('key-input').value;
                key2 = document.getElementById('key-input-2').value;
                text = document.getElementById('text-input').value;
            } else {
                key = document.getElementById('key-input').value;
                text = document.getElementById('text-input').value;
            }

            // Placeholder encryption logic
            switch(currentCipher) {
                case 'caesar':
                    location.href = `{% url 'cipher:caesar_cipher' %}?key=${key}&text=${text}&mode=encrypt`;
                    break;
                case 'vigenere':
                    resultOutput.textContent = 'Vigenere Cipher Encryption Result';
                    break;
                case 'playfair':
                    location.href = `{% url 'cipher:playfair_cipher' %}?key=${key}&text=${text}&mode=encrypt`;
                    break;
                case 'single-columnar':
                    resultOutput.textContent = 'Single Columnar Cipher Encryption Result';
                    break;
                case 'double-columnar':
                    location.href = `{% url 'cipher:double-columnar_cipher' %}?key=${key}&key2=${key2}&text=${text}&mode=encrypt`;
                    break;
                case 'aes':
                    resultOutput.textContent = 'AES Cipher Encryption Result';
                    break;
            }
        }

        function decrypt() {
            const resultOutput = document.getElementById('result-output');
            let key, key2, text;

            // Get inputs based on current cipher
            if (currentCipher === 'double-columnar') {
                key = document.getElementById('key-input').value;
                key2 = document.getElementById('key-input-2').value;
                text = document.getElementById('text-input').value;
            } else {
                key = document.getElementById('key-input').value;
                text = document.getElementById('text-input').value;
            }

            // Placeholder decryption logic
            switch(currentCipher) {
                case 'caesar':
                    location.href = `{% url 'cipher:caesar_cipher' %}?key=${key}&text=${text}&mode=decrypt`;
                    break;
                case 'vigenere':
                    resultOutput.textContent = 'Vigenere Cipher Decryption Result';
                    break;
                case 'playfair':
                    location.href = `{% url 'cipher:playfair_cipher' %}?key=${key}&text=${text}&mode=decrypt`;
                    break;
                case 'single-columnar':
                    resultOutput.textContent = 'Single Columnar Cipher Decryption Result';
                    break;
                case 'double-columnar':
                    location.href = `{% url 'cipher:double-columnar_cipher' %}?key=${key}&key2=${key2}&text=${text}&mode=decrypt`;
                    break;
                case 'aes':
                    resultOutput.textContent = 'AES Cipher Decryption Result';
                    break;
            }
        }

        function showModal(steps) {
            // Replace the content of the modal's container with the steps
            document.getElementById('modal-steps-container').innerHTML = steps;
            // Display the modal
            document.getElementById('solution-modal').style.display = 'block';
        }
        
        function closeModal() {
            // Hide the modal
            document.getElementById('solution-modal').style.display = 'none';
        }
    </script>
    <script src="{% static 'js/script.js' %}"></script>
</body>
</html>